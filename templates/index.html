<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Dobby Money</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dobby">





    <header class="dobby_header">
        <div class="dobby_header_title">
            <h1 class="dobby_header_title_text">
                Smart Dobby
            </h1>
            <span id="last-updated" class="dobby_header_title_date">

            </span>
            <a href="/refresh" class="btn"> Re </a>
        </div>
        <nav>
            <a href="/" class="{{ 'active' if page == 'home' else '' }}">í™ˆ</a>
            <a href="/sector" class="{{ 'active' if page == 'sector' else '' }}">ì—…ì¢… ë¶„ì„</a>
            <a href="/consecutive" class="{{ 'active' if page == 'consecutive' else '' }}">ì—°ì† ìˆœë§¤ìˆ˜</a>
            <a href="/abc" class="{{ 'active' if page == 'abc' else '' }}">ì§‘í•© ì „ëµ</a>
        </nav>
    </header>





    <main class="dobby_body">





        {% if page == 'home' %}
            <section class="dobby_body_con">
                <p class="dobby_body_con_info">
                    ìƒë‹¨ ë©”ë‰´ë¥¼ í†µí•´ ìŠ¤ë§ˆíŠ¸ë¨¸ë‹ˆ ìˆ˜ê¸‰ í˜„í™©ì„ ë¶„ì„í•˜ì„¸ìš”.
                </p>
                <div class="dobby_body_con_filter">
                    <div class="dobby_body_con_filter_search">
                        <input class="dobby_body_con_filter_search_box" type="text" id="stock-input" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ ì…ë ¥ (ì˜ˆ: ì‚¼ì„±ì „ì)" onkeyup="searchStocks()">
                        <input type="hidden" id="stock-code">
                    </div>
                    <div id="search-results" class="dobby_body_con_filter_result"></div>
                </div>
                
                <div id="stock-info-panel" class="dobby_body_con_summary" style="display: none;">
                    <div class="dobby_body_con_summary_wrapper">
                        <p class="dobby_body_con_summary_text">
                            í˜„ì¬ê°€: <span id="info-price" style="color: #333;">-</span>
                        </p>
                        <p class="dobby_body_con_summary_text">
                            ìŠ¤ë§ˆíŠ¸ í‰ë‹¨: <span id="info-avg" style="color: #3B6DD5;">-</span>
                        </p>
                        <p class="dobby_body_con_summary_text">
                            ê´´ë¦¬ìœ¨: <span id="info-disparity" style="color: #b42727;">-</span>
                        </p>
                        <p class="dobby_body_con_summary_text">
                            20ì¼ ìˆœë§¤ìˆ˜: <span id="info-netbuy">-</span>
                        </p>
                    </div>
                </div>

                <div class="dobby_body_con_result">
                    <div id="stock-chart-container" class="dobby_body_con_result_inner">
                        <canvas id="stockChart"></canvas>
                    </div>
                </div>
                
                
            </section>
        




        {% elif page == 'sector' %}
            <section class="dobby_body_con">
                <h2 class="dobby_body_con_title">
                    ì£¼ë„ ì—…ì¢… ({{ days }}ì¼ ê¸°ì¤€)
                </h2>
                <div class="filter-controls">
                    <a href="/sector?days=1" class="{{ 'active' if days == 1 else '' }}">1ì¼</a>
                    <a href="/sector?days=3" class="{{ 'active' if days == 3 else '' }}">3ì¼</a>
                    <a href="/sector?days=5" class="{{ 'active' if days == 5 else '' }}">5ì¼</a>
                </div>
                <div class="dobby_body_con_table">
                    <table>
                        <thead>
                            <tr>
                                <th class="center">ìˆœìœ„</th>
                                <th>ì—…ì¢…ëª…</th>
                                <th>ìˆœë§¤ìˆ˜í•©ê³„ (ì–µ)</th>
                                <th>ë§¤ìˆ˜ ê°•ë„ (í™•ì‚°ë„)</th>
                                <th class="center">ìƒì„¸ë³´ê¸°</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data %}
                            <tr onclick="toggleDetail('{{ row.Sector }}')" style="cursor: pointer;">
                                <td class="center">{{ loop.index }}</td>
                                <td style="font-weight: bold;">{{ row.Sector }}</td>
                                <td style="color: {{ '#e73c3c' if row.NetBuyAmt_100M > 0 else '#3c56e7' }};">
                                    {{ row.NetBuyAmt_100M }}
                                </td>
                                <td>
                                    <div class="dobby_body_con_table_chart">
                                        <div class="dobby_body_con_table_chart_bar" style="">
                                            <div style="width: {{ row.Breadth }}%; height: 100%; background: {{ '#e73c3c' if row.Breadth > 50 else '#a7a7a7' }};"></div>
                                        </div>
                                        <span>{{ row.Breadth }}%</span>
                                    </div>
                                </td>
                                <td class="center">ğŸ”½</td>
                            </tr>
                            <tr id="detail-{{ row.Sector }}" style="display: none; background-color: #f8f9fa;">
                                <td colspan="5">
                                    <div class="dobby_body_con_table_inner">
                                        <h4 class="dobby_body_con_table_inner_title">
                                            {{ row.Sector }} Top 5 Picks
                                        </h4>
                                        <table style="width: 100%; font-size: 0.9em; background: white;">
                                            <thead>
                                                <tr style="background: #e9ecef;">
                                                    <th>ì¢…ëª©ëª…</th>
                                                    <th>ì—…ì¢…</th>
                                                    <th>ìˆœë§¤ìˆ˜ (ì–µ)</th>
                                                    <th>í˜„ì¬ê°€</th>
                                                    <th>ê´´ë¦¬ìœ¨</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for pick in top_picks[row.Sector] %}
                                                <tr>
                                                    <td>{{ pick.name }} ({{ pick.code }})</td>
                                                    <td>{{ pick.sector }}</td>
                                                    <td style="color: {{ 'red' if pick.net_buy > 0 else 'blue' }};">{{ pick.net_buy }}</td>
                                                    <td>{{ "{:,}".format(pick.price) }}</td>
                                                    <td style="color: {{ 'red' if pick.disparity > 0 else 'blue' }};">{{ pick.disparity }}%</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
            </section>
            
            <script>
                function toggleDetail(sector) {
                    const row = document.getElementById('detail-' + sector);
                    if (row.style.display === 'none') {
                        row.style.display = 'table-row';
                    } else {
                        row.style.display = 'none';
                    }
                }
            </script>





        {% elif page == 'consecutive' %}
            <section class="dobby_body_con">
                <h2 class="dobby_body_con_title">
                    {{ days }}ì¼ ì—°ì† ìˆœë§¤ìˆ˜ ì¢…ëª© (í°ì† ì •ë ¬)
                </h2>
                <div class="filter-controls">
                    <a href="/consecutive?days=3" class="{{ 'active' if days == 3 else '' }}">3ì¼</a>
                    <a href="/consecutive?days=5" class="{{ 'active' if days == 5 else '' }}">5ì¼</a>
                    <a href="/consecutive?days=7" class="{{ 'active' if days == 7 else '' }}">7ì¼</a>
                    <a href="/consecutive?days=10" class="{{ 'active' if days == 10 else '' }}">10ì¼</a>
                </div>
                <div class="dobby_body_con_table">
                    <table>
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>ì¢…ëª©ëª…</th>
                                <th>ì—…ì¢…</th>
                                <th>ì´ ìˆœë§¤ìˆ˜ (ì–µ)</th>
                                <th>í˜„ì¬ê°€</th>
                                <th>ê´´ë¦¬ìœ¨</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td style="font-weight: bold;">{{ row.name }} <span style="font-size:0.8em; color:#888;">({{ row.code }})</span></td>
                                <td>{{ row.sector }}</td>
                                <td style="color: red;">{{ row.total_net }}</td>
                                <td>{{ "{:,}".format(row.curr_price) }}</td>
                                <td style="color: {{ 'red' if row.disparity > 0 else 'blue' }};">{{ row.disparity }}%</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" style="text-align:center; padding: 20px;">
                                í•´ë‹¹ ê¸°ê°„ ë™ì•ˆ ì—°ì†ìœ¼ë¡œ ë§¤ìˆ˜í•œ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. (ê¸°ê°„ì„ ì¤„ì—¬ë³´ì„¸ìš”!)
                            </td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>





        {% elif page == 'abc' %}
            <section class="dobby_body_con ver02">
                <div class="dobby_body_con_li">
                    <h3 class="dobby_body_con_title">
                        ìµœì¢… ì„ ì • (Aê·¸ë£¹ - B, C ì œì™¸)
                    </h3>
                    <p class="dobby_body_con_info">
                        * 20ì¼ ìˆœë§¤ìˆ˜ ìƒìœ„ 30ìœ„ ì¤‘, ìµœê·¼ 5ì¼ ëŒ€ëŸ‰ ìœ ì¶œ(B) ë° 3ì¼ ìˆœë§¤ë„(C) ì¢…ëª© ì œì™¸<br>
                        * <strong>20ì¼ ìˆœë§¤ìˆ˜ ê¸ˆì•¡ ìˆœ</strong> ì •ë ¬ (ìˆ˜ê¸‰ ìš°ì„ )
                    </p>
                    <div class="dobby_body_con_table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ì¢…ëª©ëª…</th>
                                    <th>20ì¼ ìˆœë§¤ìˆ˜(ì–µ)</th>
                                    <th>ê´´ë¦¬ìœ¨</th>
                                    <th>í˜„ì¬ê°€</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in final %}
                                <tr>
                                    <td style="font-weight: bold;">{{ item.name }} <span style="font-size:0.8em; color:#888;">({{ item.code }})</span></td>
                                    <td style="color: red;">{{ item.net_buy }}</td>
                                    <td style="color: {{ 'red' if item.disparity > 0 else 'blue' }};">{{ item.disparity }}%</td>
                                    <td>{{ "{:,}".format(item.price) }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4">ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div  class="dobby_body_con_li disabled">
                    <h3 class="dobby_body_con_title">
                        ì œì™¸ëœ ì¢…ëª© (Risk)
                    </h3>
                    <div class="dobby_body_con_table">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>ì¢…ëª©ëª…</th>
                                    <th>ì œì™¸ ì‚¬ìœ </th>
                                    <th>20ì¼ ìˆœë§¤ìˆ˜(ì–µ)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in excluded %}
                                <tr>
                                    <td>{{ item.name }}</td>
                                    <td style="color: #e74c3c; font-weight: bold;">{{ item.reason }}</td>
                                    <td>{{ item.net_buy }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="3">ì œì™¸ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        {% endif %}





    </main>

    <script>
        let debounceTimer;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const res = await fetch('/metadata');
            const meta = await res.json();
            if(meta.last_updated) {
                document.getElementById('last-updated').textContent = `ê¸°ì¤€ì¼: ${meta.last_updated} (ìµœì‹ )`;
            }
        });

        async function searchStocks() {
            const query = document.getElementById('stock-input').value;
            const resultsDiv = document.getElementById('search-results');
            
            if (query.length < 1) {
                resultsDiv.style.display = 'none';
                return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                const response = await fetch(`/search_stock?q=${query}`);
                const data = await response.json();
                
                resultsDiv.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'search-item';
                        div.textContent = `${item.Name} (${item.Code})`;
                        div.onclick = () => selectStock(item.Code, item.Name);
                        resultsDiv.appendChild(div);
                    });
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.style.display = 'none';
                }
            }, 300);
        }

        function selectStock(code, name) {
            document.getElementById('stock-input').value = `${name} (${code})`;
            document.getElementById('stock-code').value = code;
            document.getElementById('search-results').style.display = 'none';
            loadStock(code);
        }

        async function loadStock(code) {
            if(!code) return;
            
            const response = await fetch(`/stock_api?code=${code}`);
            const data = await response.json();
            
            if(data.dates && data.dates.length > 0) {
                // Update Info Panel
                document.getElementById('stock-info-panel').style.display = 'block';
                if(data.info) {
                    document.getElementById('info-price').textContent = data.info.current_price.toLocaleString() + 'ì›';
                    document.getElementById('info-avg').textContent = data.info.smart_avg.toLocaleString() + 'ì›';
                    
                    const dispElem = document.getElementById('info-disparity');
                    dispElem.textContent = data.info.disparity + '%';
                    dispElem.style.color = data.info.disparity > 0 ? 'red' : 'blue';
                    
                    const netElem = document.getElementById('info-netbuy');
                    netElem.textContent = data.info.total_net_buy + 'ì–µ';
                    netElem.style.color = data.info.total_net_buy > 0 ? 'red' : 'blue';
                }

                const ctx = document.getElementById('stockChart').getContext('2d');
                if(window.myChart) window.myChart.destroy();
                
                window.myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.dates,
                        datasets: [{
                            label: 'ìˆœë§¤ìˆ˜ (+)',
                            data: data.net_buy.map(v => v >= 0 ? v : null),
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            stack: 'stack0',
                            yAxisID: 'y',
                            order: 2
                        }, {
                            label: 'ìˆœë§¤ìˆ˜ (-)',
                            data: data.net_buy.map(v => v < 0 ? v : null),
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            stack: 'stack0',
                            yAxisID: 'y',
                            order: 2
                        }, {
                            label: 'ì£¼ê°€',
                            data: data.prices,
                            type: 'line',
                            borderColor: '#333',
                            borderWidth: 2,
                            pointRadius: 3,
                            yAxisID: 'y1',
                            order: 1
                        }, {
                            label: 'ìŠ¤ë§ˆíŠ¸ í‰ë‹¨',
                            data: new Array(data.dates.length).fill(data.info.smart_avg),
                            type: 'line',
                            borderColor: '#9b59b6',
                            borderWidth: 2,
                            pointRadius: 0,
                            yAxisID: 'y1',
                            order: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: { 
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: 'ìˆœë§¤ìˆ˜ (ì–µ)' }
                            },
                            y1: { 
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                title: { display: true, text: 'ì£¼ê°€ (ì›)' }
                            }
                        }
                    }
                });
            } else {
                alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>
